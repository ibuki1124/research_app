<%# app/views/articles/_ai_judgment_results.html.erb %>

<% 
  verdict = judgment_data['verdict']
  credibility_score = judgment_data['credibility_score'].to_i
  
  # 1. 判定結果に基づいた色とテキストの設定
  if verdict == 'misinformation'
    color_code = '#c00'; display_text = '偽・誤情報の可能性が高い'
    bg_color = '#fdd'
  elsif verdict == 'unverified'
    color_code = '#fa0'; display_text = '真偽不明'
    bg_color = '#ffe'
  else # 'true'
    color_code = '#0a0'; display_text = '真実の可能性が高い'
    bg_color = '#dfd'
  end

  # 2. Credibility Score (1-5) の説明テキストの設定
  score_explanation = case credibility_score
    when 5 then "正確: 信頼できる情報源の全てが、真実性を一貫して強く支持しており、誤りが無く重要な要素が欠けていない。"
    when 4 then "ほぼ正確: 信頼できる情報源の大半が真実性を支持し、重要な部分を含む大部分は正しいが、一部に軽微な誤りの示唆がある程度。"
    when 3 then "真偽不明: 根拠がないか不十分であり事実の検証ができない。または、真偽について意見が分かれている（情報源が矛盾している）。"
    when 2 then "不正確: 一部は正しいが、信頼できる情報源が重要な部分に誤りや欠落があると複数指摘している、またはミスリードの可能性が高い。"
    when 1 then "誤り: 信頼できる情報源の全てが、検索内容を誤りである、または重要な要素が大きく欠けていると一貫して強く指摘している。"
    else "---"
  end
%>

<div id="ai-search-results-content" style="border: 1px solid <%= color_code %>; padding: 15px; margin-top: 20px; background-color: <%= bg_color %>;">
  
  <h3>🚨 AIによる情報検証結果: <%= display_text %> 🚨</h3> 
  
  <p>
    <strong>信憑性スコア:</strong>
    <br>
    <span style="font-size: 1.2em; color: <%= color_code %>;">
      <%= credibility_score %>/5
    </span>
    <br>
    (<%= score_explanation %>)
  </p>
  <p>
    <strong>判定根拠:</strong>
    <br>
    <%= judgment_data['reason'] %>
  </p>
</div>

<div class="border p-3 mt-3 bg-light">
  <h4>参照された外部情報</h4>
  <% if external_articles.present? %>
    <ul class="list-unstyled accordion" id="external-articles-list">
      <% external_articles.each_with_index do |article, index| %>
        <% unique_id = "collapse-search-#{index}" %>
        <li class="mb-3 pb-2 border-bottom" style="border-bottom-style: dashed !important;">
          <%# 💡 元の記事タイトル %>
          <% if article['url'].present? %>
            <a href="<%= article['url'] %>" target="_blank">
              <b><%= article['title'] %></b> (元の記事へ)
            </a>
          <% else %>
            <b><%= article['title'] %></b> (リンクなし)
          <% end %>
          <%# 💡 Google検索リンク %>
          <% if article['search_url'].present? %>
            <div class="mt-2">
              <span class="toggle-icon-wrapper" data-bs-toggle="collapse" data-bs-target="#<%= unique_id %>" aria-expanded="false" aria-controls="<%= unique_id %>" style="cursor: pointer; font-size: 0.9em;">
                <i class="fa-solid fa-chevron-right toggle-icon me-1"></i>
                リンクが開けない場合はこちら
              </span>
            </div>
            <div class="collapse mt-2" id="<%= unique_id %>" data-bs-parent="#external-articles-list">
              <span class="d-inline-block p-2 border rounded" style="background-color: #e6f0ff; border-color: #c0d8ff;">
                <a href="<%= article['search_url'] %>" target="_blank" style="color: #004085; font-size: 0.95em; text-decoration: none;">
                  <i class="fa-solid fa-magnifying-glass fa-lg"></i> Google検索で確認
                </a>
              </span>
            </div>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% else %>
    <p>参照された外部情報は見つかりませんでした。</p>
  <% end %>
</div>