<%# ---------------------------------------------------- %>
<%# 【非同期AI検索結果のコンテナ】 %>
<div class="mt-3" id="ai-search-results" data-identifier="<%= @ai_search_id %>">
  <% if @search_term.present? %>
    <div id="current-search-data" data-term="<%= @search_term %>" style="display: none;"></div>
  <% end %>
  <% if @search_term.present? && @use_ai %>
    <div class="ai-loading-message card border-info shadow-sm">
      <div class="card-body text-center py-5">
        <%# Bootstrapのローディングアニメーション %>
        <div class="spinner-border text-info mb-3" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h5 class="fw-bold text-dark mb-2" id="loading-main-text">AI情報検証を実行中です</h5>
        <p class="text-secondary mb-3" id="loading-sub-text">検証には30秒ほどかかります</p>
        <%# 経過時間とステータス表示 %>
        <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
          <span class="badge rounded-pill bg-light text-dark border">
            経過時間: <span id="ai-timer">0</span>秒
          </span>
          <span id="ai-status-announcement" class="small text-muted italic"></span>
        </div>
        <%# プログレスバー（アニメーション付き） %>
        <div class="progress mx-auto" style="height: 10px; max-width: 400px;">
          <div id="ai-progress-bar" 
            class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
            role="progressbar" style="width: 0%"></div>
        </div>
      </div>
    </div>
  <% elsif @search_term.present? %>
    <div class="card border-0 shadow-sm bg-light mb-4">
      <div class="card-body py-4 px-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div class="d-flex align-items-center">
            <div class="bg-white rounded-circle p-3 shadow-sm me-3 text-primary">
              <i class="fa-solid fa-wand-magic-sparkles fa-lg"></i>
            </div>
            <div>
              <h6 class="mb-1 fw-bold text-dark">AI情報検証はオフになっています</h6>
              <p class="mb-0 text-muted small">
                AI検索を有効にすると、インターネット上の最新情報を元に内容の信憑性を自動で検証できます。
              </p>
            </div>
          </div>
          <div>
            <button type="button" 
                    class="btn btn-outline-primary btn-sm rounded-pill px-3 fw-bold" 
                    data-bs-toggle="modal" 
                    data-bs-target="#searchModal">
              <i class="fa-solid fa-sliders me-1"></i>設定を変更して検索
            </button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
<%# ---------------------------------------------------- %>

<table class="table table-hover mt-4">
  <thead class="table-light">
    <tr>
      <th>タイトル</th>
    </tr>
  </thead>
  <tbody id="articles-list"> <%# 💡 IDを追加 %>
    <%= render partial: 'article', collection: @articles %>
  </tbody>
</table>

<div class="d-flex justify-content-center my-3">
  <div class="spinner-border" role="status" id="loading-spinner" style="display: none;">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div id="pagination-links" style="display: none;">
  <%= paginate @articles, remote: true %>
</div>

<%# ======================================================= %>
<%# 【新規】検索モーダルの定義 =============================== %>
<%# ======================================================= %>
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen d-flex">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="searchModalLabel">記事の検索・絞り込み / 情報の検証</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%# --- 💡 修正: タブナビゲーションを追加 --- %>
      <ul class="nav nav-tabs" id="searchTab" role="tablist">
        <li class="nav-item flex-fill" role="presentation">
          <%# activeクラスは、現在の検索パラメータ（params[:q][:tag_in]）に応じて動的に設定することも可能ですが、ここではデフォルトをキーワードにします %>
          <button class="nav-link w-100 active" id="keyword-tab" data-bs-toggle="tab" data-bs-target="#keyword-pane" type="button" role="tab" aria-controls="keyword-pane" aria-selected="true">検索</button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
          <button class="nav-link w-100" id="tag-tab" data-bs-toggle="tab" data-bs-target="#tag-pane" type="button" role="tab" aria-controls="tag-pane" aria-selected="false">タグ絞り込み</button>
        </li>
      </ul>
      <%= search_form_for @q, url: articles_path, method: :get, class:"d-flex flex-column form-height" do |f| %>
        <div class="tab-content flex-grow-1" id="searchTabContent">
          <%# --- 💡 1. キーワード検索タブ (既存のフォームを配置) --- %>
          <div class="tab-pane fade show active h-100" id="keyword-pane" role="tabpanel" aria-labelledby="keyword-tab">
            <div class="modal-body h-100 d-flex flex-column overflow-x-hidden">
              <div class="row g-3 align-items-center mb-4">
                <%# --- 2. AI検証トグル --- %>
                <% is_on = params[:use_ai_check] == '1' %>
                <div class="col-md-auto me-auto d-flex">
                  <%= f.label :use_ai_check, "AI情報検証", class: 'form-label d-block text-end mb-0 me-1' %>
                  <%= hidden_field_tag :use_ai_check, (is_on ? '1' : ''), id: 'use-ai-hidden-field' %>
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" role="switch" id="ai-check-toggle" <%= 'checked' if is_on %>>
                    <label class="form-check-label" for="ai-check-toggle" id="ai-check-label"></label>
                  </div>
                  <button type="button" 
                          class="btn btn-outline-primary btn-sm rounded-pill py-0 px-2 ms-2 d-flex align-items-center shadow-sm" 
                          data-bs-toggle="offcanvas" 
                          data-bs-target="#aiSearchHintOffcanvas" 
                          style="font-size: 0.75rem; height: 24px; border-width: 1px;">
                    <i class="fa-solid fa-circle-info me-1"></i>
                    <span>使い方</span>
                  </button>
                </div>
                <%# --- 1. 検索タイプ --- %>
                <div class="col-md-4 <%= 'd-none' if is_on %>" id="search-type-container">
                  <%= select_tag 'search_type', options_for_select([
                    ['部分一致', 'cont'],['完全一致', 'eq'],['前方一致', 'start'],['後方一致', 'end']
                  ], params[:search_type].presence || 'cont'), class: 'form-select', id: 'search_type' %>
                </div>
              </div>
              <%# --- 3. 入力フィールドのコンテナ --- %>
              <div id="search-input-container" class="flex-grow-1">
                <%# 通常のテキストフィールド (デフォルト) %>
                <div id="normal-search-field" style="<%= 'display: none;' if is_on %>">
                  <%= text_field_tag "search_placeholder", @search_term,
                      placeholder: "キーワードを入力", 
                      class: 'form-control', 
                      id: 'search-input-field',
                      name: (is_on ? '' : "search_placeholder"), 
                      data: { ransack_base: "article_title_or_lead_text" } %>
                </div>
                <%# AI検索用テキストエリア (AI ON時) %>
                <div id="ai-search-textarea" class="h-100" style="<%= 'display: none;' unless is_on %>">
                  <%= text_area_tag "search_placeholder", @search_term,
                      placeholder: "フェイクニュースの可能性を検証したい内容を記載してください。\nより詳細な情報を提供するほど、AIの検証精度が向上します。\n（例：記事のタイトル、記事の要約、疑わしい点など）",
                      class: 'form-control h-100',
                      style: 'resize: none;',
                      id: 'search-input-textarea',
                      name: (is_on ? "search_placeholder" : ''),
                      data: { ransack_base: "article_title_or_lead_text" } %>
                </div>
              </div>
            </div>
          </div>
          <%# --- 💡 2. タグ検索タブ (新規作成) --- %>
          <div class="tab-pane fade" id="tag-pane" role="tabpanel" aria-labelledby="tag-tab">
            <div class="modal-body">
              <p class="form-label">タグ名を入力し、候補から選択してください。</p>
              <%# タグ入力フィールドと予測表示のコンテナ %>
              <div class="input-group mb-3">
                <%= text_field_tag 'tag_input', '', 
                    placeholder: "タグを入力...", 
                    class: 'form-control', 
                    id: 'tag-search-input',
                    autocomplete: 'off' %>
              </div>
              <%# 💡 選択されたタグを保持するための隠しフィールド (Ransackのtag_in検索に使用) %>
              <%# name属性を 'q[tag_in]' に設定し、Ransackで処理できるようにする %>
              <%= hidden_field_tag 'q[tag_in]', 
                  params[:q] && params[:q][:tag_in], 
                  id: 'selected-tags-hidden', 
                  # 初期状態では name 属性を削除しておく（JavaScriptで有効化する）
                  name: '' %>
              <div id="tag-suggestions" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
                <%# JavaScriptで予測タグが表示される場所 %>
              </div>
              <p class="form-label mt-4">選択中のタグ:</p>
              <div id="selected-tags-display" class="d-flex flex-wrap gap-2">
                <%# 選択されたタグチップ（バッジ）がここに表示される %>
              </div>
            </div>
          </div>
        </div>
        <%# --- フッター（クリアボタン、実行ボタン）は共通 --- %>
        <div class="modal-footer d-flex justify-content-between mt-au">
          <div>
            <%# ページ遷移を防ぎ、フォームの内容を初期状態にリセットするボタン %>
            <button type="button" id="clear-search-link" class="btn btn-outline-secondary">クリア</button>
          </div>
          <div class="d-flex">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">キャンセル</button>
            <%= f.submit "検索", id: 'submit-search-button', class: 'btn btn-primary' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="modal fade" id="externalModal" tabindex="-1" aria-labelledby="externalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="height: 90vh;">
        <div class="modal-content h-100">
            <div class="modal-header bg-light d-flex align-items-center">
              <h5 class="modal-title modal-title-scrollable flex-grow-1 me-3" id="externalModalLabel">
                  参考記事
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
            <div class="modal-body p-0 d-flex flex-column">
                <div class="iframe-container overflow-hidden "style="flex: 1 1 auto; min-height: 0;">
                    <iframe id="embeddedIframe" src="" loading="lazy" class="w-100 h-100 border-0"></iframe>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
              <div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <a id="openInNewTab" href="#" target="_blank" class="btn btn-outline-primary">元サイトで開く (別タブ)</a>
              </div>
              <div class="position-relative">
                <button 
                  class="btn btn-outline-secondary rounded-circle p-2" 
                  type="button" 
                  data-bs-toggle="offcanvas" 
                  data-bs-target="#externalModalHint" 
                  aria-controls="externalModalHint" 
                  style="width: 42px; height: 42px;" 
                  title="ヘルプを表示"
                >
                  <i class="fa-solid fa-circle-question fa-lg"></i>
                </button>
                <span class="position-absolute top-0 badge rounded-pill bg-danger" style="font-size: 0.6rem; right: -5px; transform: translateY(-30%);">
                  ヘルプ
                </span>
              </div>
            </div>
        </div>
    </div>
</div>

<%# --- ヒント Offcanvas コンポーネント --- %>
<div class="offcanvas offcanvas-end shadow" id="externalModalHint" aria-labelledby="externalModalHintLabel" style="z-index: 1065; width: 80%;" data-bs-focus="false" data-bs-scroll="true">
    <div class="offcanvas-header bg-dark text-white">
        <h5 class="offcanvas-title fw-bold" id="externalModalHintLabel">
            <i class="fa-solid fa-circle-question me-2"></i>ヘルプ
        </h5>
        <button type="button" class="btn-close btn-close-white text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-4">
        <div class="mb-4">
            <h6 class="fw-bold d-flex align-items-center text-primary">
                <i class="fa-solid fa-triangle-exclamation me-2"></i>表示エラー・真っ白な場合
            </h6>
            <div class="p-3 bg-light border rounded mt-2">
                <p class="small mb-2">
                  サイト内の一部機能は、セキュリティやプライバシー保護のために制限されています。
                </p>
            </div>
        </div>

        <div class="mb-4">
            <h6 class="fw-bold d-flex align-items-center text-primary mb-3">
                <i class="fa-solid fa-shield-halved me-2"></i>制限される主な機能
            </h6>
            <ul class="list-group list-group-flush small">
                <li class="list-group-item px-0 bg-transparent border-0 py-1">
                  <i class="fa-solid fa-ban me-2 text-danger opacity-75"></i>動画のフルスクリーン表示
                </li>
                <li class="list-group-item px-0 bg-transparent border-0 py-1">
                  <i class="fa-solid fa-ban me-2 text-danger opacity-75"></i>位置情報の取得
                </li>
                <li class="list-group-item px-0 bg-transparent border-0 py-1">
                  <i class="fa-solid fa-ban me-2 text-danger opacity-75"></i>ファイルのダウンロード
                </li>
                <li class="list-group-item px-0 bg-transparent border-0 py-1">
                  <i class="fa-solid fa-ban me-2 text-danger opacity-75"></i>サイトへのログイン
                </li>
            </ul>
        </div>

        <div class="alert alert-info border-0 shadow-sm small py-3 mt-2" role="alert">
          <div class="d-flex align-items-center mb-2 fw-bold">
            <i class="fa-solid fa-lightbulb me-2"></i>解決方法
          </div>
          <p class="mb-0 text-dark">
            すべての機能を利用するには、画面下の<strong>「元サイトで開く」</strong>ボタンから別タブで閲覧してください。
          </p>
        </div>
    </div>
</div>

<%# --- オフキャンバス：判定基準の一覧 --- %>
<div class="offcanvas offcanvas-end shadow" id="scoreCriteriaOffcanvas" aria-labelledby="scoreCriteriaOffcanvasLabel" style="z-index: 1065; width: 80%;" data-bs-focus="false" >
  <div class="offcanvas-header bg-light">
    <h5 class="offcanvas-title fw-bold" id="scoreCriteriaOffcanvasLabel">信憑性スコアの判定基準</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <p class="small text-muted mb-4">日本の主要なファクトチェック機関の基準を参考に、AIが5段階で評価しています。</p>
    
    <div class="list-group list-group-flush">
      <div class="list-group-item border-start border-4 border-success">
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1 fw-bold text-success">5: 正確</h6>
        </div>
        <p class="mb-1 small">信頼できる情報源の全てが真実性を強く支持しており、誤りが無い。</p>
      </div>

      <div class="list-group-item border-start border-4 border-info">
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1 fw-bold text-info">4: ほぼ正確</h6>
        </div>
        <p class="mb-1 small">大半が真実性を支持し大部分は正しいが、一部に軽微な誤りがある程度。</p>
      </div>

      <div class="list-group-item border-start border-4 border-warning">
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1 fw-bold text-warning">3: 真偽不明</h6>
        </div>
        <p class="mb-1 small">根拠が不十分であり検証できない。または、情報源同士の意見が分かれている。</p>
      </div>

      <div class="list-group-item border-start border-4 border-orange" style="border-color: #fd7e14 !important;">
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1 fw-bold" style="color: #fd7e14;">2: 不正確</h6>
        </div>
        <p class="mb-1 small">一部は正しいが、重要な部分に誤りや欠落がある、またはミスリードの可能性が高い。</p>
      </div>

      <div class="list-group-item border-start border-4 border-danger">
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1 fw-bold text-danger">1: 誤り</h6>
        </div>
        <p class="mb-1 small">全ての情報源が誤り、または重要な要素が大きく欠けていると一貫して指摘している。</p>
      </div>
    </div>
  </div>
</div>

<%# --- オフキャンバス：AI検索の使い方とON/OFFの違い --- %>
<div class="offcanvas offcanvas-end shadow" id="aiSearchHintOffcanvas" tabindex="-1" aria-labelledby="aiSearchHintOffcanvasLabel" style="z-index: 1080; width: 85%; max-width: 450px;" data-bs-focus="false">
  <div class="offcanvas-header bg-primary text-white">
    <h5 class="offcanvas-title fw-bold" id="aiSearchHintOffcanvasLabel">
      <i class="fa-solid fa-wand-magic-sparkles me-2"></i>AI情報検証ガイド
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body p-4">
    <div class="mb-4">
      <h6 class="fw-bold text-primary mb-2">
        <i class="fa-solid fa-robot me-2"></i>AI情報検証とは？
      </h6>
      <p class="small text-dark leading-relaxed bg-light p-3 rounded border-start border-3 border-primary">
        入力されたニュースや噂について、AIがリアルタイムでインターネット上の信頼できる情報源を調査し、その信憑性を5段階で判定する機能です。
      </p>
    </div>
    <div class="row g-3">
      <%# OFF時の説明 %>
      <div class="col-12">
        <div class="card border-0 bg-light shadow-sm">
          <div class="card-body">
            <h6 class="fw-bold text-secondary d-flex align-items-center mb-2">
              <span class="badge bg-secondary me-2">OFF</span> キーワード検索
            </h6>
            <ul class="small text-muted ps-3 mb-0" style="list-style-type: none;">
              <li><i class="fa-solid fa-check-circle me-1 text-secondary"></i> 本アプリが保存している過去記事から探す</li>
              <li><i class="fa-solid fa-check-circle me-1 text-secondary"></i> 特定の単語やタグで素早く絞り込む</li>
              <li><i class="fa-solid fa-check-circle me-1 text-secondary"></i> 待ち時間なし（即時表示）</li>
            </ul>
          </div>
        </div>
      </div>
      <%# ON時の説明 %>
      <div class="col-12">
        <div class="card border-info-subtle bg-info-subtle border-0 shadow-sm">
          <div class="card-body">
            <h6 class="fw-bold text-primary d-flex align-items-center mb-2">
              <span class="badge bg-primary me-2">ON</span> AI情報検証
            </h6>
            <ul class="small text-dark ps-3 mb-0" style="list-style-type: none;">
              <li><i class="fa-solid fa-magnifying-glass me-1 text-primary"></i> <strong>世の中で話題の最新ニュース</strong>を調査</li>
              <li><i class="fa-solid fa-clock me-1 text-primary"></i> 完了まで約30秒ほど必要</li>
              <li><i class="fa-solid fa-pen-fancy me-1 text-primary"></i> 文章で詳しく入力するほど精度が向上</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <%# 使い分けのコツ %>
    <div class="mt-4 p-3 rounded-3 bg-warning-subtle border border-warning-subtle shadow-sm">
      <h6 class="fw-bold small mb-2 d-flex align-items-center">
        <i class="fa-solid fa-lightbulb text-warning me-2 fa-lg"></i>
        使い分けのヒント
      </h6>
      <div class="small text-dark" style="line-height: 1.6;">
        <p class="mb-2"><strong>通常検索（OFF）</strong>で期待する記事が見つからない場合は、<strong>AI検証（ON）</strong>に切り替えてみてください。</p>
        <p class="mb-0">「あのニュース本当かな？」と疑問に思った内容をそのまま文章で入力することで、AIが外部サイトから新しい情報を探し出します。</p>
      </div>
    </div>
    <div class="text-center mt-4">
      <button type="button" class="btn btn-secondary btn-sm rounded-pill px-4" data-bs-dismiss="offcanvas">
        閉じる
      </button>
    </div>
  </div>
</div>