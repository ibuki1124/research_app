<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <%= link_to "フェイクニュース検索サイト", root_path, class: "h1 link-underline link-underline-opacity-0" %>
    <%# 検索モーダルを開くボタンを設置 %>
    <a href="#" data-bs-toggle="modal" data-bs-target="#searchModal" role="button" aria-label="検索・絞り込みを開く" style="text-decoration: none; color: inherit;">
      <i class="fa-solid fa-magnifying-glass fa-2x"></i>
    </a>
  </div>

  <%# ---------------------------------------------------- %>
  <%# 【非同期AI検索結果のコンテナ】 %>
  <div id="ai-search-results" data-identifier="<%= session.id %>">
    <% if @search_term.present? %>
      <div id="current-search-data" data-term="<%= @search_term %>" style="display: none;"></div>
    <% end %>
    <hr>
    <% if @search_term.present? && @use_ai %>
      <h2>AI検索による関連記事</h2>
      <%# ジョブ実行中、ここにローディングメッセージを表示 %>
      <div class="ai-loading-message alert alert-info" role="alert">
        <p>AIが関連記事を検索中です... (30秒程度かかります)</p>
      </div>
    <% elsif @search_term.present? %>
      <div class="alert alert-warning" role="alert">
        <p>AI検索を実行するには、AI検索を有効化してください。</p>
      </div>
    <% end %>
  </div>
  <%# ---------------------------------------------------- %>

  <table class="table table-hover mt-4">
    <thead class="table-light">
      <tr>
        <th>タイトル</th>
      </tr>
    </thead>
    <tbody id="articles-list"> <%# 💡 IDを追加 %>
      <%= render partial: 'article', collection: @articles %>
    </tbody>
  </table>

  <div id="loading-spinner" style="display: none; text-align: center;" class="mt-0">
    <div class="loader">Loading...</div>
  </div>

  <div id="pagination-links" style="display: none;">
    <%= paginate @articles, remote: true %>
  </div>

  <%# Action Cableチャンネル接続用のJavaScriptタグを追記 %>
  <%= javascript_pack_tag 'ai_search_channel' %>
  <%= javascript_pack_tag 'articles_index' %>
</div>

<%# ======================================================= %>
<%# 【新規】検索モーダルの定義 =============================== %>
<%# ======================================================= %>
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="searchModalLabel">記事の検索・絞り込み</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%# --- 💡 修正: タブナビゲーションを追加 --- %>
      <ul class="nav nav-tabs" id="searchTab" role="tablist">
        <li class="nav-item flex-fill" role="presentation">
          <%# activeクラスは、現在の検索パラメータ（params[:q][:tag_in]）に応じて動的に設定することも可能ですが、ここではデフォルトをキーワードにします %>
          <button class="nav-link w-100 active" id="keyword-tab" data-bs-toggle="tab" data-bs-target="#keyword-pane" type="button" role="tab" aria-controls="keyword-pane" aria-selected="true">キーワード検索</button>
        </li>
        <li class="nav-item flex-fill" role="presentation">
          <button class="nav-link w-100" id="tag-tab" data-bs-toggle="tab" data-bs-target="#tag-pane" type="button" role="tab" aria-controls="tag-pane" aria-selected="false">タグ検索</button>
        </li>
      </ul>
      <%= search_form_for @q, url: articles_path, method: :get do |f| %>
        <div class="tab-content" id="searchTabContent">
          <%# --- 💡 1. キーワード検索タブ (既存のフォームを配置) --- %>
          <div class="tab-pane fade show active" id="keyword-pane" role="tabpanel" aria-labelledby="keyword-tab">
            <div class="modal-body">
              <div class="row g-3 align-items-end mb-4">
                <%# --- 1. 検索タイプ --- %>
                <div class="col-md-auto">
                  <%= f.label :article_title_or_lead_text, "タイトルまたはリード文", class: 'form-label' %>
                </div>
                <div class="col-md-4">
                  <%= select_tag 'search_type', options_for_select([
                    ['部分一致', 'cont'],['完全一致', 'eq'],['前方一致', 'start'],['後方一致', 'end']
                  ], params[:search_type].presence || 'cont'), class: 'form-select', id: 'search_type' %>
                </div>
                <%# --- 2. AI検証トグル --- %>
                <div class="col-md-auto ms-auto">
                  <%= f.label :use_ai_check, "AI情報検証", class: 'form-label d-block text-end' %>
                  <% is_on = params[:use_ai_check] == '1' %>
                  <%= hidden_field_tag :use_ai_check, (is_on ? '1' : ''), id: 'use-ai-hidden-field' %>
                  <div class="form-check form-switch d-flex justify-content-end align-items-center mt-1">
                    <input class="form-check-input" type="checkbox" role="switch" id="ai-check-toggle" <%= 'checked' if is_on %>>
                    <label class="form-check-label ms-2" for="ai-check-toggle" id="ai-check-label">
                      <%= is_on ? '検証 ON' : '検証 OFF' %>
                    </label>
                  </div>
                </div>
              </div>
              <%# --- 3. 入力フィールドのコンテナ --- %>
              <div id="search-input-container">
                <%# 通常のテキストフィールド (デフォルト) %>
                <div id="normal-search-field" style="<%= 'display: none;' if is_on %>">
                  <%= text_field_tag "search_placeholder", @search_term,
                      placeholder: "キーワードを入力", 
                      class: 'form-control', 
                      id: 'search-input-field',
                      name: (is_on ? '' : "search_placeholder"), 
                      data: { ransack_base: "article_title_or_lead_text" } %>
                </div>
                <%# AI検索用テキストエリア (AI ON時) %>
                <div id="ai-search-textarea" style="<%= 'display: none;' unless is_on %>">
                  <%= text_area_tag "search_placeholder", @search_term,
                      placeholder: "フェイクニュースの可能性を検証したい内容を記載してください。\nより詳細な情報を提供するほど、AIの検証精度が向上します。\n（例：記事のタイトル、記事の要約、疑わしい点など）",
                      class: 'form-control',
                      id: 'search-input-textarea',
                      rows: 5,
                      name: (is_on ? "search_placeholder" : ''),
                      data: { ransack_base: "article_title_or_lead_text" } %>
                </div>
              </div>
            </div>
          </div>
          <%# --- 💡 2. タグ検索タブ (新規作成) --- %>
          <div class="tab-pane fade" id="tag-pane" role="tabpanel" aria-labelledby="tag-tab">
            <div class="modal-body">
              <p class="form-label">タグ名を入力し、候補から選択してください。</p>
              <%# タグ入力フィールドと予測表示のコンテナ %>
              <div class="input-group mb-3">
                <%= text_field_tag 'tag_input', '', 
                    placeholder: "タグを入力...", 
                    class: 'form-control', 
                    id: 'tag-search-input',
                    autocomplete: 'off' %>
              </div>
              <%# 💡 選択されたタグを保持するための隠しフィールド (Ransackのtag_in検索に使用) %>
              <%# name属性を 'q[tag_in]' に設定し、Ransackで処理できるようにする %>
              <%= hidden_field_tag 'q[tag_in]', 
                  params[:q] && params[:q][:tag_in], 
                  id: 'selected-tags-hidden', 
                  # 初期状態では name 属性を削除しておく（JavaScriptで有効化する）
                  name: '' %>
              <div id="tag-suggestions" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;">
                <%# JavaScriptで予測タグが表示される場所 %>
              </div>
              <p class="form-label mt-4">選択中のタグ:</p>
              <div id="selected-tags-display" class="d-flex flex-wrap gap-2">
                <%# 選択されたタグチップ（バッジ）がここに表示される %>
              </div>
            </div>
          </div>
        </div>
        <%# --- フッター（クリアボタン、実行ボタン）は共通 --- %>
        <div class="modal-footer d-flex justify-content-between">
          <div>
            <%# ページ遷移を防ぎ、フォームの内容を初期状態にリセットするボタン %>
            <button type="button" id="clear-search-link" class="btn btn-outline-secondary">クリア</button>
          </div>
          <div class="d-flex">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">キャンセル</button>
            <%= f.submit "検索実行", id: 'submit-search-button', class: 'btn btn-primary' %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="modal fade" id="externalModal" tabindex="-1" aria-labelledby="externalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="height: 90vh;">
        <div class="modal-content h-100">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="externalModalLabel">参考記事</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 d-flex flex-column">
                <div class="iframe-container overflow-hidden "style="flex: 1 1 auto; min-height: 0;">
                    <iframe id="embeddedIframe" src="" loading="lazy" class="w-100 h-100 border-0"></iframe>
                </div>
            </div>
            <div class="modal-footer justify-content-start">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <a id="openInNewTab" href="#" target="_blank" class="btn btn-outline-primary">元サイトで開く (別タブ)</a>
            </div>
        </div>
    </div>
</div>